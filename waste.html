<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>将棋の殿堂｜賞金ランキング</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="style.css?v=20250926a" />
  <style>
    main > section:first-of-type {
      display: grid;
      grid-auto-flow: row;
      gap: 8px;
      padding-block: 8px;
    }
    main > section:first-of-type > p[role="status"] {
      margin: 0;
      text-align: center;
    }
    main > section:first-of-type > div {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }
    main > section:first-of-type select {
      padding: 6px 8px;
      min-width: 120px;
    }
  </style>
</head>
<body>
<header>
  <h1><a href="./index.html">将棋の殿堂</a></h1>
</header>

<main>
  <!-- 年度選択UI -->
  <section>
    <div>
      <select id="year-select">
        <option value="">全年度</option>
        <!-- JSで西暦を追加 -->
      </select>
    </div>
    <p role="status" aria-live="polite"></p>
  </section>

  <!-- ランキング表示テーブル -->
  <table>
    <thead></thead>
    <tbody></tbody>
  </table>

  <div class="free">
    <h3>補足情報</h3>
    <p>各棋士の年齢は、各対象年の12月31日時点のもの。</p>
    <p>各対象年の12月31日時点の各棋士の段位・称号を正確に調べるのは極めて困難なので当分は非表示です。</p>
  </div>
</main>

<footer>著作権情報</footer>

<script>
(() => {
  const CSV_PATH = './prize-ranking.csv';
  const V = '20250926-a';

  // ---- 既存の手書きCSVパーサ（無改変） ----
  function parseCSV(text) {
    const rows = [];
    let row = [], col = '', q = false;
    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      if (q) {
        if (c === '"') {
          if (text[i + 1] === '"') { col += '"'; i++; } else { q = false; }
        } else { col += c; }
      } else {
        if (c === '"') q = true;
        else if (c === ',') { row.push(col); col = ''; }
        else if (c === '\r') { /* skip */ }
        else if (c === '\n') { row.push(col); rows.push(row); row = []; col = ''; }
        else { col += c; }
      }
    }
    if (col.length || row.length) { row.push(col); rows.push(row); }
    return rows;
  }

  // ---- 既存DOM参照（セレクタは不変） ----
  const section = document.querySelector('main > section:first-of-type');
  const yearSelect = section.querySelector('#year-select');
  const statusP = section.querySelector('p[role="status"]');
  const table = document.querySelector('main table');
  const thead = table.querySelector('thead');
  const tbody = table.querySelector('tbody');

  // ---- 描画ユーティリティ（既存仕様を踏襲） ----
  function renderHead(headerNames) {
    thead.innerHTML = '';
    const tr = document.createElement('tr');
    headerNames.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      th.setAttribute('scope', 'col');
      tr.appendChild(th);
    });
    thead.appendChild(tr);
  }
  function renderBody(rows) {
    tbody.innerHTML = '';
    const frag = document.createDocumentFragment();
    rows.forEach(r => {
      const tr = document.createElement('tr');
      r.forEach(cell => {
        const td = document.createElement('td');
        td.textContent = cell;
        tr.appendChild(td);
      });
      frag.appendChild(tr);
    });
    tbody.appendChild(frag);
  }
  function updateStatus(text) { statusP.textContent = text; }
  const fmtInt = n => (+n || 0).toLocaleString('ja-JP');

  // ---- 内部状態（DOMは増やさない） ----
  let header = [];
  let data = [];
  let idx = {};
  let years = [];
  let mode = 'year';           // 'year' | 'player' | 'sum10' | 'top10'
  let currentYear = null;      // string
  let currentPlayer = null;    // string

  // 「棋士名」列が何番目に表示されているか（年別/歴代Top10でのみ使用）
  let nameColPos = -1;

  // 棋士別インデックス：Map<name, Array<{year, rank, amount, prizeText}>>
  const playerIndex = new Map();

  // ---- 初期化 ----
  async function main() {
    updateStatus('読み込み中…');
    const res = await fetch(`${CSV_PATH}?v=${V}`, { cache: 'no-store' });
    if (!res.ok) throw new Error('CSV取得に失敗しました: ' + res.status);
    const text = await res.text();
    const rows = parseCSV(text);
    if (!rows.length) throw new Error('CSVが空です');

    header = rows[0];
    data = rows.slice(1);

    idx = {
      year:   header.indexOf('西暦'),
      rank:   header.indexOf('順位'),
      name:   header.indexOf('棋士名'),
      amount: header.indexOf('金額'),           // ← 計算・並べ替えは必ずコレ
      age:    header.indexOf('年齢'),           // 無ければ -1
      prizeT: header.indexOf('賞金・対局料'),   // 表示用テキスト
    };
    if ([idx.year, idx.rank, idx.name, idx.amount, idx.prizeT].some(i => i === -1)) {
      throw new Error('必須列（西暦/順位/棋士名/金額/賞金・対局料）が不足しています');
    }

    // 年リスト（降順）を作成
    years = [...new Set(data.map(r => String(r[idx.year])))]
      .filter(Boolean)
      .sort((a, b) => Number(b) - Number(a));

    // 年セレクト：年のみ＋機能項目（sum10/top10）を追加
    yearSelect.innerHTML =
      years.map(y => `<option value="${y}">${y}年</option>`).join('') +
      `<option value="sum10">年別Top10合計</option>` +
      `<option value="top10">歴代Top10</option>`;
    currentYear = years[0];
    yearSelect.value = currentYear;

    // 棋士別インデックスを構築（年降順で保持）
    for (const r of data) {
      const name = r[idx.name];
      if (!name) continue;
      const entry = {
        year: Number(r[idx.year]),
        rank: r[idx.rank],
        amount: toAmount(r[idx.amount]),
        prizeText: r[idx.prizeT]
      };
      if (!playerIndex.has(name)) playerIndex.set(name, []);
      playerIndex.get(name).push(entry);
    }
    for (const arr of playerIndex.values()) {
      arr.sort((a, b) => b.year - a.year);
    }

    // 初期表示：年別
    mode = 'year';
    renderYear(currentYear);

    // イベント：年セレクト
    yearSelect.addEventListener('change', () => {
      const v = yearSelect.value;
      if (v === 'sum10') {
        mode = 'sum10'; currentPlayer = null; renderSum10();
      } else if (v === 'top10') {
        mode = 'top10'; currentPlayer = null; renderTop10();
      } else {
        mode = 'year'; currentYear = v; currentPlayer = null; renderYear(v);
      }
    });

    // イベント：表内クリック（「棋士名」セル → ③棋士別）
    tbody.addEventListener('click', (e) => {
      const cell = e.target.closest('td');
      if (!cell) return;
      if (nameColPos === -1) return;                // 現在の表示に「棋士名」列が無い
      const tr = cell.parentElement;
      const cells = Array.from(tr.children);
      const clickedIsName = cells.indexOf(cell) === nameColPos;
      if (!clickedIsName) return;

      // クリックされた行の「棋士名」を取得
      const name = cells[nameColPos].textContent.trim();
      if (!name) return;

      mode = 'player';
      currentPlayer = name;
      renderPlayer(name);
    });
  }

  // 金額（数値列）を数値化：カンマ除去→Number
  function toAmount(v) {
    if (typeof v === 'number') return v;
    if (v == null) return 0;
    const s = String(v).replace(/,/g, '');
    const n = Number(s);
    return isNaN(n) ? 0 : n;
  }

  // 順位の数値化（例：「10位タイ」→ 10）
  function toRankInt(v) {
    const m = String(v).match(/\d+/);
    return m ? Number(m[0]) : NaN;
  }

  // ---- 各モード描画（同じ table を使い回し） ----

  // 年別（既存＋列調整：段位・称号は出さない）
  function renderYear(yearStr) {
    const want = ['順位', '棋士名'];
    if (idx.age !== -1) want.push('年齢');
    want.push('賞金・対局料');
    renderHead(want);

    // 「棋士名」列の位置を記録（クリックで③へ）
    nameColPos = want.indexOf('棋士名');

    const rows = data.filter(r => String(r[idx.year]) === String(yearStr));
    const out = rows.map(r => {
      const arr = [ r[idx.rank], r[idx.name] ];
      if (idx.age !== -1) arr.push(r[idx.age]);
      arr.push(r[idx.prizeT]);
      return arr;
    });
    renderBody(out);
    updateStatus(`${yearStr}年：${out.length}件`);
  }

  // ③ 棋士別：年 / 順位 / 賞金・対局料
  function renderPlayer(name) {
    const head = ['西暦', '順位', '賞金・対局料'];
    renderHead(head);
    nameColPos = -1; // このビューには「棋士名」列は無い

    const list = playerIndex.get(name) || [];
    const out = list.map(x => [ String(x.year), x.rank, x.prizeText ]);
    renderBody(out);

    if (list.length) {
      const minY = list[list.length - 1].year;
      const maxY = list[0].year;
      updateStatus(`${name}：${minY}〜${maxY}年、${list.length}件`);
    } else {
      updateStatus(`${name}：0件`);
    }
  }

  // ④ 年別Top10合計：年 / 上位10名 合計（金額列を合算）
  function renderSum10() {
    const head = ['西暦', '上位10名 合計'];
    renderHead(head);
    nameColPos = -1;

    // 年ごとに top10（順位1〜10）の金額を合算
    const byYear = new Map(); // year -> sum
    for (const y of years) { byYear.set(y, 0); }

    for (const r of data) {
      const y = String(r[idx.year]);
      if (!byYear.has(y)) continue;
      const rankN = toRankInt(r[idx.rank]);
      if (rankN >= 1 && rankN <= 10) {
        byYear.set(y, byYear.get(y) + toAmount(r[idx.amount]));
      }
    }

    const out = Array.from(byYear.entries())
      .sort((a, b) => Number(b[0]) - Number(a[0])) // 年降順
      .map(([y, sum]) => [ y, fmtInt(sum) ]);

    renderBody(out);
    updateStatus(`年別Top10合計：${out.length}年`);
  }

  // ⑤ 歴代Top10：西暦 / 棋士名 / （年齢） / 賞金・対局料
  function renderTop10() {
    const head = ['西暦', '棋士名'];
    if (idx.age !== -1) head.push('年齢');
    head.push('賞金・対局料');
    renderHead(head);

    // 「棋士名」列の位置を記録（Top10でも名前クリックで③へ）
    nameColPos = head.indexOf('棋士名');

    // 全行から金額降順でTop10
    const top = data
      .map(r => ({
        year: String(r[idx.year]),
        name: r[idx.name],
        age:  idx.age !== -1 ? r[idx.age] : null,
        prizeT: r[idx.prizeT],
        amount: toAmount(r[idx.amount]),
      }))
      .sort((a, b) => b.amount - a.amount)
      .slice(0, 10);

    const out = top.map(x => {
      const arr = [ x.year, x.name ];
      if (idx.age !== -1) arr.push(x.age);
      arr.push(x.prizeT);
      return arr;
    });
    renderBody(out);
    updateStatus('歴代Top10：10件');
  }

  // ---- 実行 ----
  main().catch(err => {
    console.error(err);
    updateStatus('エラー：' + err.message);
  });
})();
</script>
</body>
</html>