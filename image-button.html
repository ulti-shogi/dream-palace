<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>将棋の殿堂｜賞金ランキング</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="style.css?v=20250925e" />

    <!-- html2canvas（DOM→画像化ライブラリ） -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html-to-image@1.11.11/dist/html-to-image.min.js"></script>

  <style>
    main > section:first-of-type {
      display: grid;
      grid-auto-flow: row;
      gap: 8px;
      padding-block: 8px;
    }
    main > section:first-of-type > p[role="status"] {
      margin: 0;
      text-align: center;
    }
    main > section:first-of-type > div {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }
    main > section:first-of-type select {
      padding: 6px 8px;
      min-width: 120px;
    }

  /* 右下に常時表示する保存ボタン */
  #capture-btn{
    position: fixed;
    right: 16px;
    bottom: 16px;
    z-index: 1000;
    padding: 10px 14px;
    border: none;
    border-radius: 10px;
    background: #4CAF50;
    color: #fff;
    font-size: 14px;
    box-shadow: 0 4px 12px rgba(0,0,0,.2);
  }
  #capture-btn:disabled{ opacity:.6; }
  </style>
</head>
<body>
<header>
  <h1><a href="./index.html">将棋の殿堂</a></h1>
</header>

<main>
  <!-- 年度選択UI -->
  <section>
    <div>
      <select id="year-select">
        <option value="">全年度</option>
        <!-- JSで西暦を追加 -->
      </select>
    </div>
    <p role="status" aria-live="polite"></p>
  </section>

  <!-- ランキング表示テーブル -->
  <table>
    <thead></thead>
    <tbody></tbody>
  </table>

  <!-- 画像保存ボタン（常時表示） -->
  <button id="capture-btn" type="button" aria-label="表示中のランキングを画像として保存">
    画像として保存
  </button>
    
  <div class="free">
    <h3>このページについて</h3>
    <p>このページでは <code>prize-ranking.csv</code> を読み込み、西暦で年度を選んで絞り込みます。</p>
  </div>
</main>

<footer>将棋の殿堂（データパレス）</footer>

<script>
(() => {
  const CSV_PATH = './prize-ranking.csv';
  const V = '20250925e';

  function parseCSV(text) {
    const rows = [];
    let row = [], col = '', q = false;
    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      if (q) {
        if (c === '"') {
          if (text[i + 1] === '"') { col += '"'; i++; }
          else { q = false; }
        } else { col += c; }
      } else {
        if (c === '"') q = true;
        else if (c === ',') { row.push(col); col = ''; }
        else if (c === '\r') { /* skip */ }
        else if (c === '\n') { row.push(col); rows.push(row); row = []; col = ''; }
        else { col += c; }
      }
    }
    if (col.length || row.length) { row.push(col); rows.push(row); }
    return rows;
  }

  const section = document.querySelector('main > section:first-of-type');
  const yearSelect = section.querySelector('#year-select');
  const statusP = section.querySelector('p[role="status"]');
  const table = document.querySelector('main table');
  const thead = table.querySelector('thead');
  const tbody = table.querySelector('tbody');

  function renderHead(header) {
    thead.innerHTML = '';
    const tr = document.createElement('tr');
    header.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      th.setAttribute('scope', 'col');
      tr.appendChild(th);
    });
    thead.appendChild(tr);
  }

  function renderBody(rows) {
    tbody.innerHTML = '';
    const frag = document.createDocumentFragment();
    rows.forEach(r => {
      const tr = document.createElement('tr');
      r.forEach(cell => {
        const td = document.createElement('td');
        td.textContent = cell;
        tr.appendChild(td);
      });
      frag.appendChild(tr);
    });
    tbody.appendChild(frag);
  }

  function updateStatus(n, total) {
    statusP.textContent = total ? `${n}件（全${total}件）` : `${n}件`;
  }

  async function main() {
    statusP.textContent = '読み込み中…';
    const res = await fetch(`${CSV_PATH}?v=${V}`, { cache: 'no-store' });
    if (!res.ok) throw new Error('CSV取得に失敗しました: ' + res.status);
    const text = await res.text();
    const rows = parseCSV(text);
    if (rows.length === 0) throw new Error('CSVが空です');

    const header = rows[0];
    const data = rows.slice(1);

    // 表示する列のインデックスを動的に決定
    const displayedCols = ['順位', '棋士名', '段位・称号', '年齢', '賞金・対局料'];
    const colIndexes = displayedCols.map(c => header.indexOf(c));

    renderHead(displayedCols);
    renderBody(data.map(r => colIndexes.map(i => r[i])));
    updateStatus(data.length, rows.length - 1);

    // 西暦列を探す
    const yearColIndex = header.indexOf('西暦');
    if (yearColIndex === -1) throw new Error('西暦列が見つかりません');

    // 西暦一覧を抽出して<select>に追加
    const years = [...new Set(data.map(r => r[yearColIndex]))].sort((a, b) => b - a);
    years.forEach(y => {
      const opt = document.createElement('option');
      opt.value = y;
      opt.textContent = y + '年';
      yearSelect.appendChild(opt);
    });

    // 年度選択イベント
    yearSelect.addEventListener('change', () => {
      const selected = yearSelect.value;
      const filtered = selected
        ? data.filter(r => r[yearColIndex] === selected)
        : data;
      renderBody(filtered.map(r => colIndexes.map(i => r[i])));
      updateStatus(filtered.length, data.length);
    });
  }

  main().catch(err => {
    console.error(err);
    statusP.textContent = 'エラー：' + err.message;
  });
})();

(() => {
  const btn = document.getElementById('capture-btn');
  if (!btn) return;

  btn.addEventListener('click', async () => {
    const target = document.querySelector('main table');
    if (!target) return alert('テーブルが見つかりません');

    const year = (document.getElementById('year-select')?.value || 'all');
    const prev = btn.textContent;
    btn.disabled = true; btn.textContent = '画像生成中…';

    try {
      if (document.fonts?.ready) await document.fonts.ready;

      // 1) 対象テーブルのクローンを作り、画面外に一時配置
      const clone = target.cloneNode(true);
      Object.assign(clone.style, {
        position: 'fixed',
        left: '-10000px',
        top: '0',
        visibility: 'hidden',
        backgroundColor: getComputedStyle(target).backgroundColor || '#ffffff'
      });
      document.body.appendChild(clone);

      // 2) 各セル(th,td)に計算済みスタイルをインライン適用（背景色が抜ける対策）
      const origCells  = target.querySelectorAll('th, td');
      const cloneCells = clone.querySelectorAll('th, td');
      origCells.forEach((el, i) => {
        const s = getComputedStyle(el);
        const c = cloneCells[i];
        c.style.backgroundColor = s.backgroundColor;
        c.style.color           = s.color;
        c.style.font            = s.font;             // font-family/size/weight まとめて
        c.style.lineHeight      = s.lineHeight;
        c.style.letterSpacing   = s.letterSpacing;
        c.style.verticalAlign   = s.verticalAlign;
        c.style.borderColor     = s.borderColor;
        c.style.borderStyle     = s.borderStyle;
        c.style.borderWidth     = s.borderWidth;
        c.style.paddingTop      = s.paddingTop;
        c.style.paddingBottom   = s.paddingBottom;
        c.style.paddingLeft     = s.paddingLeft;
        c.style.paddingRight    = s.paddingRight;
        // 必要なら textAlign なども追加
      });

      // 3) html-to-image でPNGに（失敗時は html2canvas にフォールバック）
      let dataUrl;
      try {
        dataUrl = await htmlToImage.toPng(clone, {
          backgroundColor: '#ffffff',
          pixelRatio: 2
        });
      } catch (e) {
        console.warn('html-to-image 失敗 → html2canvasで再試行', e);
        const canvas = await html2canvas(clone, { backgroundColor: '#ffffff', scale: 2 });
        dataUrl = canvas.toDataURL('image/png');
      } finally {
        clone.remove();
      }

      // 4) タイトル合成 → ダウンロード
      const img = new Image();
      img.src = dataUrl;
      await img.decode();

      const pad = 20, titleH = 48;
      const out = document.createElement('canvas');
      out.width  = img.width + pad * 2;
      out.height = img.height + pad * 3 + titleH;

      const ctx = out.getContext('2d');
      ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, out.width, out.height);
      ctx.fillStyle = '#000';
      ctx.font = 'bold 28px system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif';
      ctx.textBaseline = 'top';
      ctx.fillText(`${year}年 賞金ランキング`, pad, pad);
      ctx.drawImage(img, pad, pad * 2 + titleH);

      out.toBlob((blob) => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `prize-ranking_${year}.png`;
        a.click();
        URL.revokeObjectURL(a.href);
      }, 'image/png');
    } catch (e) {
      alert('画像化に失敗：' + e.message);
      console.error(e);
    } finally {
      btn.disabled = false; btn.textContent = prev;
    }
  });
})();

</script>
</body>
</html>