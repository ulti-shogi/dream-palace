<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>将棋の殿堂</title>
  <link rel="stylesheet" href="style.css?v=1.1">

  <style>
    /* ✅ アコーディオン用の最低限CSS。（既存CSSには干渉しない） */
    .accordion {
      width: 100%;
    }
    .accordion-item {
      border-bottom: 1px solid #ddd;
    }
    .accordion-header {
      width: 100%;
      text-align: left;
      padding: 10px;
      font-size: 16px;
      background-color: #f2f2f2;
      border: none;
    }
    .accordion-content {
      display: none;
      padding: 10px;
      background-color: #fff;
    }
  </style>
</head>
<body>
<header>
<h1>将棋の殿堂</h1>
</header>
<main>
  <section>

    <!-- ✅ アコーディオン構造ここから -->
    <div class="accordion">

      <!-- A: 通算・総合成績 -->
      <div class="accordion-item">
        <button class="accordion-header">通算・総合成績で検索</button>
        <div class="accordion-content">
  <!-- ✅ 通算・総合成績用の検索UI（修正版） -->
<div class="search-total">
  <label for="totalSortKey">並べ替え：</label>
  <select id="totalSortKey">
    <option value="">選択してください</option>
    <option value="total_titles">通算タイトル数</option>
    <option value="appearances">登場回数</option>
    <option value="winrate">勝率</option>
    <option value="losses">敗退数</option>
  </select>

  <div class="sort-order">
    <label>
      <input type="radio" name="totalOrder" value="desc" checked> 多い順・高い順
    </label>
    <label>
      <input type="radio" name="totalOrder" value="asc"> 少ない順・低い順
    </label>
  </div>

  <button id="totalSearchBtn">検索</button>
</div>        
        </div>
      </div>

      <!-- B: 棋戦別 -->
      <div class="accordion-item">
        <button class="accordion-header">棋戦別で検索</button>
        <div class="accordion-content">
          <p>ここに棋戦別検索UIを実装予定</p>
        </div>
      </div>

      <!-- C: 記録系 -->
      <div class="accordion-item">
        <button class="accordion-header">記録系で検索</button>
        <div class="accordion-content">
          <!-- ✅ 記録系UI -->
<div class="record-search">
  <label for="recordType">記録の種類：</label>
  <select id="recordType">
    <option value="">選択してください</option>
    <option value="youngest">タイトル獲得 最年少記録</option>
    <option value="shortest">タイトル獲得 最短記録</option>
  </select>
  <button id="recordSearchBtn">検索</button>
</div>
        </div>
      </div>

    </div>
    <!-- ✅ アコーディオンここまで -->

  </section>

  <table>
    <thead>
    <tbody>
  </table>

  <div class="free">
    <h3>自由欄</h3>
    <p>補足情報など自由に書き込む。</p>
  </div>
</main>
<footer>フッダー</footer>

<script>
  // =======================
  // グローバル
  // =======================
  let titleData = [];

  document.addEventListener("DOMContentLoaded", function() {
    loadCSV();
    setupAccordion();
    setupTotalSearch();
    setupRecordSearch();
  });

  // =======================
  // CSV 読み込み
  // =======================
  function loadCSV() {
    fetch("title.csv")
      .then(response => response.text())
      .then(text => {
        const rows = text.trim().split("\n").map(r => r.split(","));
        const header = rows[0];

        // ヘッダー名→index取得のヘルパ
        const idx = (name) => header.indexOf(name);

        // 数値化ヘルパ（小数対応 / 余計な空白やカンマだけ除去）
        const toNum = (v) => {
          if (v === undefined || v === null) return NaN;
          const s = String(v).trim().replace(/,/g, "");
          if (s === "") return NaN;
          const n = Number(s);
          return Number.isFinite(n) ? n : NaN;
        };

        // 「四段からの日数」専用：数字以外排除して整数化（より厳密）
        const toIntDaysStrict = (v) => {
          if (v === undefined || v === null) return NaN;
          const s = String(v).trim().replace(/[^\d]/g, "");
          if (s === "") return NaN;
          const n = Number(s);
          return Number.isFinite(n) ? n : NaN;
        };

        titleData = rows.slice(1).map(r => {
          return {
            // 基本
            number:        r[idx("番号")],
            order:         toNum(r[idx("並順")]),
            name:          r[idx("棋士名")],
            appearances:   toNum(r[idx("登場")]),
            total_titles:  toNum(r[idx("獲得")]),
            losses:        toNum(r[idx("敗退")]),
            winrate:       toNum(r[idx("勝率")]),
            // 記録系（最年少）
            youngestText:  header.includes("最年少記録") ? r[idx("最年少記録")] : "",
            daysFromBirth: header.includes("生年からの日数") ? toIntDaysStrict(r[idx("生年からの日数")]) : NaN,
            birthDate:     header.includes("生年月日") ? r[idx("生年月日")] : "",
            // 記録系（最短）
            shortestText:  header.includes("最短記録") ? r[idx("最短記録")] : "",
            daysFrom4dan:  header.includes("四段からの日数") ? toIntDaysStrict(r[idx("四段からの日数")]) : NaN,
            fourDanDate:   header.includes("四段昇段日") ? r[idx("四段昇段日")] : "",
            firstTitleDate:header.includes("初タイトル") ? r[idx("初タイトル")] : ""
          };
        });

        // 初期表示：獲得の多い順TOP10＋10位と同率
        const sorted = [...titleData].sort((a, b) => {
          if (a.total_titles === b.total_titles) return a.order - b.order;
          return b.total_titles - a.total_titles;
        });

        if (sorted.length === 0) { renderTable([]); return; }

        const top10 = sorted.slice(0, 10);
        const baseValue = top10[top10.length - 1].total_titles;
        const extended = sorted.filter((p, i) => i < 10 || p.total_titles === baseValue);

        renderTable(extended);
      })
      .catch(err => {
        console.error("CSVの読み込みに失敗：", err);
        renderTable([]);
      });
  }

  // =======================
  // 通算テーブル描画（順位表示 & 勝率4桁固定）
  // =======================
  function renderTable(data) {
    const table = document.querySelector("table");
    const thead = table.querySelector("thead");
    const tbody = table.querySelector("tbody");

    thead.innerHTML = `
      <tr>
        <th>順位</th>
        <th>棋士名</th>
        <th>登場</th>
        <th>獲得</th>
        <th>敗退</th>
        <th>勝率</th>
      </tr>
    `;
    tbody.innerHTML = "";

    let currentRank = 0;
    let prevValue = null;
    let count = 0;

    const sortKey = (document.getElementById("totalSortKey")?.value) || "total_titles";

    data.forEach(row => {
      count++;
      const currentValue = row[sortKey];

      if (prevValue === null || prevValue !== currentValue) {
        currentRank = count;
        prevValue = currentValue;
      }

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${currentRank}</td>
        <td>${row.name}</td>
        <td>${Number.isFinite(row.appearances) ? row.appearances : ""}</td>
        <td>${Number.isFinite(row.total_titles) ? row.total_titles : ""}</td>
        <td>${Number.isFinite(row.losses) ? row.losses : ""}</td>
        <td>${Number.isFinite(row.winrate) ? row.winrate.toFixed(4) : ""}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // =======================
  // 通算検索
  // =======================
  function setupTotalSearch() {
    const totalBtn = document.getElementById("totalSearchBtn");
    if (!totalBtn) return;

    totalBtn.addEventListener("click", function() {
      const key = document.getElementById("totalSortKey").value;
      const order = document.querySelector('input[name="totalOrder"]:checked').value;

      if (!key) { alert("並べ替え項目を選択してください"); return; }

      const sortedData = [...titleData].sort((a, b) => {
        const av = a[key], bv = b[key];
        if (av === bv) return a.order - b.order; // 同率は並順
        if (order === "asc") return av - bv;
        return bv - av;
      });

      renderTable(sortedData);
    });
  }

  // =======================
  // 記録系検索
  // =======================
  function setupRecordSearch() {
    const btn = document.getElementById("recordSearchBtn");
    if (!btn) return;

    btn.addEventListener("click", () => {
      const type = document.getElementById("recordType").value;
      if (!type) { alert("記録の種類を選択してください"); return; }

      if (type === "youngest") {
        // 最年少：生年からの日数 昇順 → 同値は並順
        const rows = [...titleData]
          .filter(r => Number.isFinite(r.daysFromBirth) && r.youngestText)
          .sort((a, b) => {
            if (a.daysFromBirth === b.daysFromBirth) return a.order - b.order;
            return a.daysFromBirth - b.daysFromBirth;
          });
        renderRecordTable(rows, "youngest");

      } else if (type === "shortest") {
        // 最短：四段からの日数 昇順 → 同値は並順
        const rows = [...titleData]
          .filter(r => Number.isFinite(r.daysFrom4dan) && r.shortestText)
          .sort((a, b) => {
            const ka = a.daysFrom4dan, kb = b.daysFrom4dan;
            if (ka === kb) return a.order - b.order;
            return ka - kb;
          });
        renderRecordTable(rows, "shortest");
      }
    });
  }

  // 記録系の描画（順位／棋士名／値／詳細）
  function renderRecordTable(rows, mode) {
    const table = document.querySelector("table");
    const thead = table.querySelector("thead");
    const tbody = table.querySelector("tbody");

    thead.innerHTML = `
      <tr>
        <th>順位</th>
        <th>棋士名</th>
        <th>${mode === "youngest" ? "獲得年齢" : "最短記録"}</th>
        <th>詳細</th>
      </tr>
    `;
    tbody.innerHTML = "";

    let currentRank = 0, prevKey = null, count = 0;

    rows.forEach(r => {
      count++;

      const rawKey = (mode === "youngest") ? r.daysFromBirth : r.daysFrom4dan;
      const key = Number.isFinite(rawKey) ? rawKey : Infinity;

      if (prevKey === null || key !== prevKey) {
        currentRank = count;
        prevKey = key;
      }

      const valueText = (mode === "youngest") ? r.youngestText : r.shortestText;

      // 本体行
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${currentRank}</td>
        <td>${r.name}</td>
        <td>${valueText}</td>
        <td><button class="detail-toggle">詳細</button></td>
      `;
      tbody.appendChild(tr);

      // 詳細行
      const detail = document.createElement("tr");
      detail.className = "detail-row";
      detail.style.display = "none";
      const detailHtml = (mode === "youngest")
        ? `生年月日：${r.birthDate || "-"}　／　獲得日：${r.firstTitleDate || "-"}`
        : `四段昇段日：${r.fourDanDate || "-"}　／　獲得日：${r.firstTitleDate || "-"}`;
      detail.innerHTML = `<td colspan="4">${detailHtml}</td>`;
      tbody.appendChild(detail);
    });

    // トグル
    tbody.querySelectorAll(".detail-toggle").forEach(btn => {
      btn.addEventListener("click", function() {
        const row = this.closest("tr").nextElementSibling;
        row.style.display = (row.style.display === "none" || row.style.display === "") ? "table-row" : "none";
      });
    });
  }

  // =======================
  // アコーディオン
  // =======================
  function setupAccordion() {
    const headers = document.querySelectorAll(".accordion-header");
    headers.forEach(header => {
      header.addEventListener("click", function() {
        const content = this.nextElementSibling;
        const visible = content.style.display === "block";
        document.querySelectorAll(".accordion-content").forEach(c => c.style.display = "none");
        content.style.display = visible ? "none" : "block";
      });
    });
  }
</script>

</body>
</html>