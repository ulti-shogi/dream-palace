<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>棋士プロフィール検索</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1><a href="https://ulti-shogi.github.io/dream-palace/index.html">将棋の殿堂</a></h1>
  </header>
<main>
  <section>
  <div id="controls">
    <fieldset>
      <legend>区分フィルタ</legend>
      <label><input type="checkbox" name="kubun" value="現役" checked> 現役</label>
      <label><input type="checkbox" name="kubun" value="引退" checked> 引退</label>
      <label><input type="checkbox" name="kubun" value="物故" checked> 物故</label>
      <label><input type="checkbox" name="kubun" value="退会" checked> 退会</label>
    </fieldset>

    <div>
      <label for="sortSelect">並び替え:</label>
      <select id="sortSelect">
        <option value="sekiji" selected>席次順</option>
        <option value="kishiNo">棋士番号順</option>
        <option value="ageAt4dan">四段昇段時年齢（若い順）</option>
      </select>
    </div>
  </div>
</section>

  <!-- 検索結果の描画先 -->
  <div class="card"></div>

    </main>
  <footer>
    将棋の殿堂
  </footer>

  <script>
const CSV_URL = "kishi.csv";

async function loadCSV(url) {
  const res = await fetch(url, { cache: "no-cache" });
  const text = await res.text();
  return parseCSV(text);
}

function parseCSV(text) {
  const lines = text.replace(/\r\n/g, "\n").trim().split("\n");
  const header = lines[0].split(",");
  return lines.slice(1).map(line => {
    const cols = line.split(",");
    const obj = {};
    header.forEach((h, i) => obj[h.trim()] = (cols[i] ?? "").trim());
    return obj;
  });
}

function renderCards(data) {
  const container = document.querySelector("div.card");
  container.innerHTML = "";

  data.forEach(row => {
    const entry = document.createElement("div");
    entry.className = "entry";
    entry.innerHTML = `
      <p><strong>${row["棋士名"]}</strong>（${row["称号"] || row["段位"] || "—"}）</p>
      <p>区分：${row["区分"] || "—"}</p>
      <p>棋士番号：${row["棋士番号"] || "—"}</p>
      <p>生年月日：${row["生年月日"] || "—"}</p>
      <p>${row["逝去日"] ? "享年" : "現在年齢"}：${row["現在年齢"] || "—"}</p>
      <p>四段昇段日：${row["四段昇段日"] || "—"}</p>
      <p>四段昇段時年齢：${row["四段昇段年齢"] || "—"}</p>
    `;
    container.appendChild(entry);
  });
}

function sortData(data, key) {
  if (key === "kishiNo") {
    data.sort((a, b) => Number(a["棋士番号"]) - Number(b["棋士番号"]));
  } else if (key === "ageAt4dan") {
    data.sort((a, b) => Number(a["四段昇段所要日数"]) - Number(b["四段昇段所要日数"]) || Number(a["席次"]) - Number(b["席次"]));
  } else {
    data.sort((a, b) => Number(a["席次"]) - Number(b["席次"]));
  }
}

function filterByKubun(data) {
  const checked = [...document.querySelectorAll("input[name='kubun']:checked")].map(cb => cb.value);
  return data.filter(row => checked.includes(row["区分"]));
}

async function init() {
  let data = await loadCSV(CSV_URL);

  // 初期表示：席次順
  sortData(data, "sekiji");
  renderCards(data);

  // 並び替えイベント
  document.querySelector("#sortSelect").addEventListener("change", e => {
    const key = e.target.value;
    sortData(data, key);
    renderCards(filterByKubun(data));
  });

  // 区分フィルタイベント
  document.querySelectorAll("input[name='kubun']").forEach(cb => {
    cb.addEventListener("change", () => {
      renderCards(filterByKubun(data));
    });
  });
}

document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>