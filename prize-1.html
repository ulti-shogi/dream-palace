<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>将棋の殿堂｜賞金ランキング</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="style.css?v=20250924d" />
  <style>
    main > section:first-of-type {
      display: grid;
      grid-auto-flow: row;
      gap: 8px;
      padding-block: 8px;
    }
    main > section:first-of-type > p[role="status"] {
      margin: 0;
      text-align: center;
    }
    main > section:first-of-type > div {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }
    main > section:first-of-type select {
      padding: 6px 8px;
      min-width: 120px;
    }
  </style>
</head>
<body>
<header>
  <h1><a href="./index.html">将棋の殿堂</a></h1>
</header>

<main>
  <!-- 年度選択UI -->
  <section>
    <div>
      <select id="year-select">
        <option value="">全年度</option>
        <!-- JSで西暦を追加 -->
      </select>
    </div>
    <p role="status" aria-live="polite"></p>
  </section>

  <!-- ランキング表示テーブル -->
  <table>
    <thead></thead>
    <tbody></tbody>
  </table>

  <div class="free">
    <h3>補足情報</h3>
    <p>このページでは <code>prize-ranking.csv</code> を読み込み、西暦で年度を選んで絞り込みます。</p>
  </div>
</main>

<footer>著作権情報</footer>

<script>
(() => {
  const CSV_PATH = './prize-ranking.csv';
  const V = '20250924d';

  function parseCSV(text) {
    const rows = [];
    let row = [], col = '', q = false;
    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      if (q) {
        if (c === '"') {
          if (text[i + 1] === '"') { col += '"'; i++; }
          else { q = false; }
        } else { col += c; }
      } else {
        if (c === '"') q = true;
        else if (c === ',') { row.push(col); col = ''; }
        else if (c === '\r') { /* skip */ }
        else if (c === '\n') { row.push(col); rows.push(row); row = []; col = ''; }
        else { col += c; }
      }
    }
    if (col.length || row.length) { row.push(col); rows.push(row); }
    return rows;
  }

  const section = document.querySelector('main > section:first-of-type');
  const yearSelect = section.querySelector('#year-select');
  const statusP = section.querySelector('p[role="status"]');
  const table = document.querySelector('main table');
  const thead = table.querySelector('thead');
  const tbody = table.querySelector('tbody');

  function renderHead(header) {
    thead.innerHTML = '';
    const tr = document.createElement('tr');
    header.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      th.setAttribute('scope', 'col');
      tr.appendChild(th);
    });
    thead.appendChild(tr);
  }

  function renderBody(rows) {
    tbody.innerHTML = '';
    const frag = document.createDocumentFragment();
    rows.forEach(r => {
      const tr = document.createElement('tr');
      r.forEach(cell => {
        const td = document.createElement('td');
        td.textContent = cell;
        tr.appendChild(td);
      });
      frag.appendChild(tr);
    });
    tbody.appendChild(frag);
  }

  function updateStatus(n, total) {
    statusP.textContent = total ? `${n}件（全${total}件）` : `${n}件`;
  }

  async function main() {
    statusP.textContent = '読み込み中…';
    const res = await fetch(`${CSV_PATH}?v=${V}`, { cache: 'no-store' });
    if (!res.ok) throw new Error('CSV取得に失敗しました: ' + res.status);
    const text = await res.text();
    const rows = parseCSV(text);
    if (rows.length === 0) throw new Error('CSVが空です');

    const header = rows[0];
    const data = rows.slice(1);

    // 表示する列のインデックスを動的に決定
    const displayedCols = ['順位', '棋士名', '段位・称号', '年齢', '賞金・対局料'];
    const colIndexes = displayedCols.map(c => header.indexOf(c));

    renderHead(displayedCols);
    renderBody(data.map(r => colIndexes.map(i => r[i])));
    updateStatus(data.length, rows.length - 1);

    // 西暦列を探す
    const yearColIndex = header.indexOf('西暦');
    if (yearColIndex === -1) throw new Error('西暦列が見つかりません');

    // 西暦一覧を抽出して<select>に追加
    const years = [...new Set(data.map(r => r[yearColIndex]))].sort((a, b) => b - a);
    years.forEach(y => {
      const opt = document.createElement('option');
      opt.value = y;
      opt.textContent = y + '年';
      yearSelect.appendChild(opt);
    });

    // 年度選択イベント
    yearSelect.addEventListener('change', () => {
      const selected = yearSelect.value;
      const filtered = selected
        ? data.filter(r => r[yearColIndex] === selected)
        : data;
      renderBody(filtered.map(r => colIndexes.map(i => r[i])));
      updateStatus(filtered.length, data.length);
    });
  }

  main().catch(err => {
    console.error(err);
    statusP.textContent = 'エラー：' + err.message;
  });
})();
</script>
</body>
</html>