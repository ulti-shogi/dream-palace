<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>将棋の殿堂｜賞金ランキング</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="stylesheet" href="style.css?v=20250926a" />
  <style>
    main > section:first-of-type {
      display: grid;
      grid-auto-flow: row;
      gap: 8px;
      padding-block: 8px;
    }
    main > section:first-of-type > p[role="status"] {
      margin: 0;
      text-align: center;
    }
    main > section:first-of-type > div {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }
    main > section:first-of-type select {
      padding: 6px 8px;
      min-width: 120px;
    }
  </style>
</head>
<body>
<header>
  <h1><a href="./index.html">将棋の殿堂</a></h1>
</header>

<main>
  <!-- 年度選択UI -->
  <section>
    <div>
      <select id="year-select">
        <option value="">全年度</option>
        <!-- JSで西暦を追加 -->
      </select>
    </div>
    <p role="status" aria-live="polite"></p>
  </section>

  <!-- ランキング表示テーブル -->
  <table>
    <thead></thead>
    <tbody></tbody>
  </table>

  <div class="free">
    <h3>補足情報</h3>
    <p>各棋士の年齢は、各対象年の12月31日時点のもの。</p>
    <p>各対象年の12月31日時点の各棋士の段位・称号を正確に調べるのは極めて困難なので当分は非表示です。</p>
  </div>
</main>

<footer>著作権情報</footer>

<script>
(() => {
  const CSV_PATH = './prize-ranking.csv';
  const V = '20250926a';

  // 既存の手書きCSVパーサ（無改変）
  function parseCSV(text) {
    const rows = [];
    let row = [], col = '', q = false;
    for (let i = 0; i < text.length; i++) {
      const c = text[i];
      if (q) {
        if (c === '"') {
          if (text[i + 1] === '"') { col += '"'; i++; }
          else { q = false; }
        } else { col += c; }
      } else {
        if (c === '"') q = true;
        else if (c === ',') { row.push(col); col = ''; }
        else if (c === '\r') { /* skip */ }
        else if (c === '\n') { row.push(col); rows.push(row); row = []; col = ''; }
        else { col += c; }
      }
    }
    if (col.length || row.length) { row.push(col); rows.push(row); }
    return rows;
  }

  // 既存DOM参照（無改変セレクタ）
  const section = document.querySelector('main > section:first-of-type');
  const yearSelect = section.querySelector('#year-select');
  const statusP = section.querySelector('p[role="status"]');
  const table = document.querySelector('main table');
  const thead = table.querySelector('thead');
  const tbody = table.querySelector('tbody');

  function renderHead(header) {
    thead.innerHTML = '';
    const tr = document.createElement('tr');
    header.forEach(h => {
      const th = document.createElement('th');
      th.textContent = h;
      th.setAttribute('scope', 'col');
      tr.appendChild(th);
    });
    thead.appendChild(tr);
  }

  function renderBody(rows) {
    tbody.innerHTML = '';
    const frag = document.createDocumentFragment();
    rows.forEach(r => {
      const tr = document.createElement('tr');
      r.forEach(cell => {
        const td = document.createElement('td');
        td.textContent = cell;
        tr.appendChild(td);
      });
      frag.appendChild(tr);
    });
    tbody.appendChild(frag);
  }

  // ステータスは「YYYY年：n件」に統一
  function updateStatus(year, n) {
    statusP.textContent = `${year}年：${n}件`;
  }

  async function main() {
    statusP.textContent = '読み込み中…';
    const res = await fetch(`${CSV_PATH}?v=${V}`, { cache: 'no-store' });
    if (!res.ok) throw new Error('CSV取得に失敗しました: ' + res.status);
    const text = await res.text();
    const rows = parseCSV(text);
    if (rows.length === 0) throw new Error('CSVが空です');

    const header = rows[0];
    const data = rows.slice(1);

    // ② 「段位・称号」を除いた表示列（年齢はCSVにあれば表示）
    const wanted = ['順位', '棋士名', '年齢', '賞金・対局料'];
    const displayedCols = wanted.filter(c => header.includes(c));
    const colIndexes = displayedCols.map(c => header.indexOf(c));
    renderHead(displayedCols);

    // 西暦列の取得
    const yearColIndex = header.indexOf('西暦');
    if (yearColIndex === -1) throw new Error('西暦列が見つかりません');

    // ① 全年度の廃止：空optionは使わず、最新年のみ初期表示
    const years = [...new Set(data.map(r => Number(r[yearColIndex])))]
      .filter(Boolean)
      .sort((a, b) => b - a);

    // 既存の「全年度」optionは捨てて年だけを再描画
    yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}年</option>`).join('');
    yearSelect.value = String(years[0]);

    // 初期表示（最新年）
    const selected = yearSelect.value;
    const filtered = data.filter(r => String(r[yearColIndex]) === selected);
    renderBody(filtered.map(r => colIndexes.map(i => r[i])));
    updateStatus(selected, filtered.length);

    // 年度選択イベント（空値は存在しない＝常に単年表示）
    yearSelect.addEventListener('change', () => {
      const y = yearSelect.value;
      const rowsY = data.filter(r => String(r[yearColIndex]) === y);
      renderBody(rowsY.map(r => colIndexes.map(i => r[i])));
      updateStatus(y, rowsY.length);
    });
  }

  main().catch(err => {
    console.error(err);
    statusP.textContent = 'エラー：' + err.message;
  });
})();
</script>
</body>
</html>